---
title: "R Notebook"
output: html_notebook
---
```{r}
#set working directory and bring in the Excel Sheet
#setwd("~/University/University 2020-2021/thesis/MicrobiomeThesis")
library(readxl)
library(tidyverse)
library(ggmosaic)
# set plotting theme
theme_set(theme_bw())
#~/University/University 2020-2021/thesis/MicrobiomeThesis/
# read in spreadsheets
ResultsMicrobiome <- read_excel("micro.xlsx")
```

```{r}
# functions for analysis
chiFilter <- function(data, core, c2){
  # data = data frame with articles
  # core = core type
  # c2 = second column of interest
  df <- data %>%
    group_by(CombinedCore) %>%
    mutate(yes_in_group = any(str_detect(CombinedCore, core))) %>%
    ungroup()
  df1 <- data.frame(df$yes_in_group, c2) %>% na.omit()
  tab <- table(df1$yes_in_group, c2)
  print(tab)
  chi <- chisq.test(tab)
  return(chi)
}

df <- ResultsMicrobiome %>%
  group_by(CombinedCore) %>%
  mutate(yes_in_group = any(str_detect(CombinedCore, 'Common'))) %>%
  ungroup()
df1 <- data.frame(df$yes_in_group, ResultsMicrobiome$FieldOfStudy)

table(df1$yes_in_group, df1$ResultsMicrobiome.FieldOfStudy)
chiFilter(ResultsMicrobiome, 'Common', ResultsMicrobiome$FieldOfStudy)
ResultsMicrobiome$FieldOfStudy
```

```{r}
# apply (quicker step)
columns <- list(ResultsMicrobiome$NestedCore,
                ResultsMicrobiome$CommonCore,
                ResultsMicrobiome$TemporalCore)
```

```{r}
# replace NAs with no
ResultsMicrobiome$NestedCore[is.na(ResultsMicrobiome$NestedCore)] <- "no"
# combine cores
ResultsMicrobiome$CombinedCore <- interaction(ResultsMicrobiome$NestedCore,
                                              ResultsMicrobiome$CommonCore,
                                              ResultsMicrobiome$TemporalCore) %>%
  str_replace_all(c("ecological.no.no" = "Ecological Only",
                  "functional.no.no" = "Functional Only",
                  "host-adapted.no.no" = "Host-adapted Only",
                  "ecological.yes.no" = "Ecological and Common",
                  "functional.yes.no" = "Functional and Common",
                  "host-adapted.yes.no" = "Host-adapted and Common",
                  "no.yes.no" = "Common Only", "no.no.yes" = "Temporal Only",
                  "ecological.yes.yes" = "Ecological, Common, Temporal",
                  "functional.yes.yes" = "Functional, Common, Temporal",
                  "no.no.no" = "None", "no.yes.yes" = "Common and Temporal",
                  "host-adapted.yes.yes" = "Host-adapted, Common, Temporal"))

ResultsMicrobiome %>%
    group_by(CombinedCore) %>%
    mutate(yes_in_group = any(str_detect(CombinedCore, 'Common'))) %>%
  select(yes_in_group)


```


### Primary Analyses, Chi Square Tests

```{r}
FOS <- chiFilter(ResultsMicrobiome$CombinedCore, ResultsMicrobiome$FieldOfStudy)
```
```{r}
HT <- chiFilter(ResultsMicrobiome$CombinedCore, ResultsMicrobiome$HostType)
```

### Secondary Analyses, Chi Square Tests

```{r}
PNI <- chiFilter(ResultsMicrobiome$CombinedCore, ResultsMicrobiome$PositiveOrNegativeInteraction)
```
```{r}
EHF <- chiFilter(ResultsMicrobiome$CombinedCore, ResultsMicrobiome$EffectOnHostFitness)
```

### Bonferroni Test

```{r}
pval <- c(FOS$p.value, HT$p.value, PNI$p.value, EHF$p.value)
pval
p.adjust(pval, method = "holm")
```

### Visualization - Mosaic Bar Plots

```{r}
# combined core
ResultsMicrobiome$CombinedCore <- factor(ResultsMicrobiome$CombinedCore,
                                         levels = c("Common Only", "Ecological Only", "Functional Only",
                                                    "Host-adapted Only", "Ecological and Common",
                                                    "Functional and Common", "Host-adapted and Common",
                                                    "Temporal (All Combinations)", "None"))
# field of study
ResultsMicrobiome$FieldOfStudy <- factor(ResultsMicrobiome$FieldOfStudy, 
                                         levels = c("Ecology", "Medical",
                                                    "Agricultural", "Industrial"))
# host types
table(ResultsMicrobiome$HostType)
ResultsMicrobiome$HostType <- factor(ResultsMicrobiome$HostType,
                                     levels = c("vertebrate", "human", "invertebrate", "soil",
                                                "plant", "sludge", "food products", "fish", "water"))
# positive/negative
table(ResultsMicrobiome$PositiveOrNegativeInteraction)
ResultsMicrobiome$PositiveOrNegativeInteraction <- factor(ResultsMicrobiome$PositiveOrNegativeInteraction,
                                     levels = c("both", "positive", "negative"))

# host fitness
table(ResultsMicrobiome$EffectOnHostFitness)
ResultsMicrobiome$EffectOnHostFitness <- factor(ResultsMicrobiome$EffectOnHostFitness,
                                     levels = c("both", "positive", "negative"))
```

```{r}
# figure foundation
f <- ggplot(ResultsMicrobiome) +
  scale_fill_viridis_d() +
  labs(fill = "Combined Core", y = "Combined Core")
```

```{r}
# field of study x core microbiome
# un-comment pdf and dev.off to export with unsquished labels
#pdf("FieldOfStudy.pdf", height = 12, width = 10)
f + geom_mosaic(aes(x = product(FieldOfStudy),
                    fill = CombinedCore)) +
  xlab("Field of Study")
#dev.off()
```


```{r}
# study system x core microbiome
f + geom_mosaic(aes(x = product(HostType),
                    fill = CombinedCore)) +
  xlab("Study System")
```

```{r}
# positive or negative interaction x core microbiome
f + geom_mosaic(aes(x = product(PositiveOrNegativeInteraction),
                    fill = CombinedCore)) +
  xlab("Interaction Type")
```

```{r}
# effect on host fitness x core microbiome
f + geom_mosaic(aes(x = product(EffectOnHostFitness),
                    fill = CombinedCore)) +
  xlab("Effect on Host Fitness")
```

## Without NA's
### Interaction Type
```{r}
interactionType <- ResultsMicrobiome %>%
  select(CombinedCore, PositiveOrNegativeInteraction) %>%
  na.omit()
```

```{r}
chiFilter(interactionType$CombinedCore, interactionType$PositiveOrNegativeInteraction)
```

```{r}
ggplot(interactionType) +
  scale_fill_viridis_d() +
  labs(fill = "Combined Core", y = "Combined Core", x = "Interaction Type") +
  geom_mosaic(aes(x = product(PositiveOrNegativeInteraction),
                    fill = CombinedCore))
```

### Effect on host fitness

```{r}
EffectOnHostFitness <- ResultsMicrobiome %>%
  select(CombinedCore, EffectOnHostFitness) %>%
  na.omit()
```

```{r}
chiFilter(EffectOnHostFitness$CombinedCore, EffectOnHostFitness$EffectOnHostFitness)
```

```{r}
ggplot(EffectOnHostFitness) +
  scale_fill_viridis_d() +
  labs(fill = "Combined Core", y = "Combined Core", x = "Effect on Host Fitness") +
  geom_mosaic(aes(x = product(EffectOnHostFitness),
                    fill = CombinedCore))
```